<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消費大獎賞2025</title>
    <style>
        :root {
            --primary-color: #28a745;
            --secondary-color: #dc3545;
            --border-radius: 5px;
            --padding: 10px;
            --shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--padding);
        }
        .container {
            max-width: 100%;
            width: 100%;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }
        h2 {
            text-align: center;
            margin-bottom: 5px;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .time-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        #recordForm {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--padding);
            margin-bottom: 15px;
        }
        #recordForm > div {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: center;
        }
        #recordForm label {
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 40px;
        }
        #recordForm select,
        #recordForm input[type="checkbox"] {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        #recordForm select {
            flex-grow: 1;
        }
        #recordForm button {
            background-color: var(--primary-color);
            color: white;
            padding: var(--padding);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
        }
        #recordForm button:hover {
            background-color: #1e7e34;
        }
        .filters {
            display: flex;
            flex-direction: row;
            gap: var(--padding);
            margin-bottom: 15px;
            align-items: center;
        }
        .filters > div {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 5px;
        }
        .filters label {
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .filters select,
        .filters button {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        .filters button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        .filters button:hover {
            background-color: #1e7e34;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 15px;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 50px;
        }
        th:nth-child(1), td:nth-child(1) {
            max-width: 30px;
        }
        th:nth-child(2), td:nth-child(2) {
            max-width: 60px;
        }
        th:nth-child(3), td:nth-child(3),
        th:nth-child(4), td:nth-child(4),
        th:nth-child(5), td:nth-child(5) {
            max-width: 40px;
        }
        th:nth-child(6), td:nth-child(6) {
            max-width: 60px;
        }
        th:nth-child(7), td:nth-child(7) {
            max-width: 40px;
        }
        th:nth-child(8), td:nth-child(8) {
            max-width: 50px;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tbody tr.used {
            text-decoration: line-through;
            color: #888;
        }
        .export-button {
            background-color: var(--secondary-color);
            color: white;
            padding: var(--padding);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .export-button:hover {
            background-color: #c82333;
        }
        .import-button {
            background-color: #007bff;
            color: white;
            padding: var(--padding);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .import-button:hover {
            background-color: #0069d9;
        }
        .draw-row {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: center;
        }
        .draw-row label {
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 30px;
        }
        .draw-row select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        .summary-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .footer-note {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            border: 1px solid #eee;
        }
        .footer-note p {
            margin: 0;
        }
        .privacy-notice {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .privacy-notice label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        @media (max-width: 480px) {
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            .filters > div {
                flex-direction: column;
                align-items: stretch;
            }
            th, td {
                font-size: 0.7rem;
                padding: 3px;
            }
            .draw-row {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>消費大獎賞2025</h2>
        <div class="time-info" id="timeInfo"></div>

        <form id="recordForm">
            <div>
                <label for="platform">平台:</label>
                <select id="platform" required>
                    <option value="">請選擇</option>
                    <option>Alipay</option>
                    <option>BOC</option>
                    <option>GFB</option>
                    <option>ICBC</option>
                    <option>Luso</option>
                    <option>MPay</option>
                    <option>TFB</option>
                    <option>UePay</option>
                </select>
            </div>
            <div>
                <label for="giveUp">
                    <input type="checkbox" id="giveUp"> 冇抽
                </label>
            </div>
            <div class="draw-row">
                <label>券:</label>
                <select id="draw1" class="draw-select">
                    <option value="-">-</option>
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                    <option>100</option>
                    <option>200</option>
                </select>
                <select id="draw2" class="draw-select">
                    <option value="-">-</option>
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                    <option>100</option>
                    <option>200</option>
                </select>
                <select id="draw3" class="draw-select">
                    <option value="-">-</option>
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                    <option>100</option>
                    <option>200</option>
                </select>
            </div>
            <button type="button" onclick="addRecord()">提交</button>
        </form>

        <div class="filters">
            <div>
                <label for="filterWeek">周數:</label>
                <select id="filterWeek">
                    <option value="">全部</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
            </div>
            <div>
                <label for="filterPlatform">平台:</label>
                <select id="filterPlatform">
                    <option value="">全部</option>
                    <option>Alipay</option>
                    <option>BOC</option>
                    <option>GFB</option>
                    <option>ICBC</option>
                    <option>Luso</option>
                    <option>MPay</option>
                    <option>TFB</option>
                    <option>UePay</option>
                </select>
            </div>
            <button onclick="filterRecords()">篩選</button>
        </div>

        <div class="summary-info" id="weeklySummary">
            本周消費券：MOP 0<br>需消費：MOP 0
        </div>

        <div class="table-container">
            <table id="recordsTable">
                <thead>
                    <tr>
                        <th>周數</th>
                        <th>平台</th>
                        <th>券1</th>
                        <th>券2</th>
                        <th>券3</th>
                        <th>消費</th>
                        <th>已使用</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button class="export-button" onclick="exportCSV()">匯出 CSV</button>
        <button class="import-button" onclick="document.getElementById('fileInput').click()">匯入 CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
        
        <div class="footer-note">
            <p>注意：所有資料儲存在Firebase數據庫中，跨設備自動同步</p>
        </div>
        
        <div class="privacy-notice">
            <h4>隱私聲明</h4>
            <p>我們使用匿名帳號保存您的數據，不會收集個人識別信息</p>
            <label>
                <input type="checkbox" id="analyticsOptOut">
                不參與使用數據分析
            </label>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // 請替換為您的Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyCRjL_wJqYvufMvtDiwEuN_vYso4cTKaKA",
            authDomain: "macau-draw.firebaseapp.com",
  	    databaseURL: "https://macau-draw-default-rtdb.asia-southeast1.firebasedatabase.app",
 	    projectId: "macau-draw",
  	    storageBucket: "macau-draw.firebasestorage.app",
  	    messagingSenderId: "953987756535",
 	    appId: "1:953987756535:web:a7a09862a1ca5aaefbfef2"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // 匿名登入狀態監聽
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("匿名用戶已登入:", user.uid);
                loadUserRecords(user.uid);
            } else {
                auth.signInAnonymously().catch((error) => {
                    console.error("匿名登入失敗:", error);
                });
            }
        });

        // 保存記錄到Firebase
        async function saveRecordToFirebase(record) {
            const user = auth.currentUser;
            if (!user) return;

            // 數據驗證
            if (!validateRecord(record)) {
                alert("無效的記錄數據！");
                return;
            }

            const userId = user.uid;
            const recordId = Date.now();
            
            try {
                await db.ref(`users/${userId}/records/${recordId}`).set({
                    ...record,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                console.log("記錄已保存");
            } catch (error) {
                console.error("保存失敗:", error);
                alert("保存失敗，請檢查網絡連接");
            }
        }

        // 數據驗證函數
        function validateRecord(record) {
            const validPlatforms = ['Alipay', 'BOC', 'GFB', 'ICBC', 'Luso', 'MPay', 'TFB', 'UePay'];
            const validCoupons = ['10', '20', '50', '100', '200', '-', 'ND'];
            
            return (
                validPlatforms.includes(record.platform) &&
                validCoupons.includes(record.draw1) &&
                validCoupons.includes(record.draw2) &&
                validCoupons.includes(record.draw3) &&
                typeof record.consumption === 'number'
            );
        }

        // 從Firebase加載記錄
        function loadUserRecords(userId) {
            const recordsRef = db.ref(`users/${userId}/records`);
            
            recordsRef.on('value', (snapshot) => {
                const records = snapshot.val() || {};
                renderRecords(records);
                updateWeeklySummary(records);
            });
        }

        // 渲染記錄到表格
        function renderRecords(records) {
            const tableBody = document.getElementById('recordsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            Object.entries(records).forEach(([id, record]) => {
                const row = tableBody.insertRow();
                if (record.used) row.classList.add('used');
                
                row.innerHTML = `
                    <td>${record.week}</td>
                    <td>${record.platform}</td>
                    <td>${record.draw1}</td>
                    <td>${record.draw2}</td>
                    <td>${record.draw3}</td>
                    <td>${formatNumber(record.consumption)}</td>
                    <td><input type="checkbox" ${record.used ? 'checked' : ''} onchange="toggleUsed('${id}', this)"></td>
                    <td><button onclick="deleteRecord('${id}')">刪除</button></td>
                `;
            });
        }

        // 刪除記錄
        window.deleteRecord = async (recordId) => {
            const user = auth.currentUser;
            if (!user) return;

            if (confirm('確定要刪除此記錄嗎？')) {
                try {
                    await db.ref(`users/${user.uid}/records/${recordId}`).remove();
                } catch (error) {
                    console.error("刪除失敗:", error);
                }
            }
        };

        // 切換使用狀態
        window.toggleUsed = async (recordId, checkbox) => {
            const user = auth.currentUser;
            if (!user) return;

            try {
                await db.ref(`users/${user.uid}/records/${recordId}/used`).set(checkbox.checked);
            } catch (error) {
                console.error("更新狀態失敗:", error);
            }
        };

        // 添加記錄
        window.addRecord = function() {
            const platform = document.getElementById("platform").value;
            let draw1 = document.getElementById("draw1").value;
            let draw2 = document.getElementById("draw2").value;
            let draw3 = document.getElementById("draw3").value;
            const giveUp = document.getElementById("giveUp").checked;

            if (!platform) {
                alert("請選擇平台！");
                return;
            }
            if (!giveUp && (draw1 === "" || draw2 === "" || draw3 === "")) {
                alert("請選擇券1, 券2, 券3！");
                return;
            }
            if (giveUp) {
                draw1 = draw2 = draw3 = "ND";
            }

            const weekNumber = getWeekNumber(new Date());
            const record = {
                week: weekNumber,
                platform,
                draw1,
                draw2,
                draw3,
                consumption: calculateConsumption(draw1, draw2, draw3),
                used: giveUp
            };

            saveRecordToFirebase(record);
            document.getElementById("recordForm").reset();
            document.getElementById("draw1").value = "-";
            document.getElementById("draw2").value = "-";
            document.getElementById("draw3").value = "-";
        };

        // 計算消費金額
        function calculateConsumption(draw1, draw2, draw3) {
            const values = [draw1, draw2, draw3].map(val => {
                if (val === '-' || val === 'ND') return 0;
                return parseInt(val) || 0;
            });
            const sum = values.reduce((a, b) => a + b, 0);
            return sum * 3; // 消費金額 = (券1+券2+券3)*3
        }

        // 更新周摘要
        function updateWeeklySummary(records) {
            const currentWeek = getWeekNumber(new Date());
            let totalCoupons = 0;
            let totalConsumption = 0;

            Object.values(records).forEach(record => {
                if (parseInt(record.week) === currentWeek) {
                    if (record.draw1 !== "ND") totalCoupons += parseInt(record.draw1) || 0;
                    if (record.draw2 !== "ND") totalCoupons += parseInt(record.draw2) || 0;
                    if (record.draw3 !== "ND") totalCoupons += parseInt(record.draw3) || 0;
                    totalConsumption += parseInt(record.consumption) || 0;
                }
            });

            document.getElementById('weeklySummary').innerText = 
                `本周消費券：MOP ${formatNumber(totalCoupons)}\n需消費：MOP ${formatNumber(totalConsumption)}`;
            document.getElementById('weeklySummary').style.color = 'green';
        }

        // 格式化數字
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // 獲取當前周數
        function getWeekNumber(date) {
            const startOfFirstWeek = new Date(2025, 2, 24); // 2025年3月24日為第一周開始
            const millisecondsPerWeek = 7 * 24 * 60 * 60 * 1000;
            return Math.floor((date - startOfFirstWeek) / millisecondsPerWeek) + 1;
        }

        // 篩選記錄
        window.filterRecords = function() {
            const week = document.getElementById("filterWeek").value;
            const platform = document.getElementById("filterPlatform").value;
            const rows = document.querySelectorAll("#recordsTable tbody tr");

            rows.forEach(row => {
                const weekCell = row.cells[0].innerText;
                const platformCell = row.cells[1].innerText;
                const matchWeek = !week || weekCell === week;
                const matchPlatform = !platform || platformCell === platform;
                row.style.display = matchWeek && matchPlatform ? "" : "none";
            });
        };

        // 導出CSV
        window.exportCSV = function() {
            const table = document.getElementById("recordsTable");
            const rows = table.querySelectorAll("tr");
            let csvContent = "\uFEFF"; // BOM頭
            
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll("th, td");
                cells.forEach((cell, index) => {
                    if (index === 6) {
                        const checkbox = cell.querySelector('input[type="checkbox"]');
                        rowData.push(checkbox?.checked ? '已使用' : '未使用');
                    } else if (index !== 7) {
                        rowData.push(cell.innerText.replace(/,/g, ''));
                    }
                });
                csvContent += rowData.join(",") + "\r\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `macaudraw-${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // 導入CSV
        window.importCSV = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const contents = e.target.result;
                const lines = contents.split('\n');
                const user = auth.currentUser;
                if (!user) return;

                let importedCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const cells = lines[i].split(',');
                    if (cells.length >= 7) {
                        const record = {
                            week: cells[0],
                            platform: cells[1],
                            draw1: cells[2],
                            draw2: cells[3],
                            draw3: cells[4],
                            consumption: parseInt(cells[5].replace(/,/g, '')) || 0,
                            used: cells[6].includes('已使用')
                        };

                        if (validateRecord(record)) {
                            await db.ref(`users/${user.uid}/records/${Date.now() + i}`).set(record);
                            importedCount++;
                        }
                    }
                }
                
                alert(`成功導入 ${importedCount} 條記錄`);
                event.target.value = '';
            };
            reader.readAsText(file);
        };

        // 初始化時間顯示
        function updateTimeInfo() {
            const now = new Date();
            const weekNumber = getWeekNumber(now);
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            };
            const timeString = now.toLocaleString('zh-HK', options);
            document.getElementById('timeInfo').innerHTML = 
                `現在時間是：${timeString}<br>本周是活動第${weekNumber}周`;
            return weekNumber;
        }

        // 初始化頁面
        updateTimeInfo();
        setInterval(updateTimeInfo, 60000); // 每分鐘更新時間

        // 隱私設置
        document.getElementById('analyticsOptOut').addEventListener('change', function(e) {
            localStorage.setItem('analyticsOptOut', e.target.checked);
        });
        document.getElementById('analyticsOptOut').checked = localStorage.getItem('analyticsOptOut') === 'true';
    </script>
</body>
</html>